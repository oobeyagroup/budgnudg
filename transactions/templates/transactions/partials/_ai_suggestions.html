{% if category_suggestion or subcategory_suggestion or payoree_suggestion or ai_reasoning %}
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-info bg-opacity-10">
        <h6 class="mb-0 text-info-emphasis">
            <i class="fas fa-robot me-2"></i>AI Suggestions
        </h6>
    </div>
    <div class="card-body">
        <!-- Clean table structure for easy targeting -->
        <div class="table-responsive">
            <table class="table table-sm" id="ai-suggestions-table">
                <thead>
                    <tr class="text-center">
                        <th scope="col">Field</th>
                        <th scope="col">Current</th>
                        <th scope="col">Train AI</th>
                        <th scope="col">AI Suggestion</th>
                        <th scope="col">Apply</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Payoree Row -->
                    <tr class="text-center align-middle" data-field="payoree">
                        <td><strong>Payoree</strong></td>
                        <td class="current-value">
                            {% if transaction.payoree %}
                                <span class="badge {% if payoree_suggestion and transaction.payoree.id == payoree_suggestion.id %}bg-success{% else %}bg-info{% endif %}">{{ transaction.payoree.name }}</span>
                            {% else %}
                                <span class="text-muted fst-italic">Not assigned</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if transaction.payoree %}
                                {% if payoree_suggestion and transaction.payoree.id == payoree_suggestion.id %}
                                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled
                                        title="AI suggestion matches current assignment">
                                        <i class="fas fa-check me-1"></i>Match
                                    </button>
                                {% else %}
                                    <button type="button" class="btn btn-outline-primary btn-sm train-ai-payoree"
                                        data-transaction-id="{{ transaction.id }}" 
                                        data-payoree-id="{{ transaction.payoree.id }}"
                                        title="Teach AI from current payoree assignment">
                                        <i class="fas fa-arrow-right me-1"></i>Train
                                    </button>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if payoree_suggestion %}
                                <span class="badge {% if transaction.payoree and transaction.payoree.id == payoree_suggestion.id %}bg-success{% else %}bg-success{% endif %}">{{ payoree_suggestion.name }}</span>
                            {% else %}
                                <span class="text-warning">
                                    <i class="fas fa-clock me-1"></i>No suggestion
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if payoree_suggestion %}
                                {% if transaction.payoree and transaction.payoree.id == payoree_suggestion.id %}
                                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled
                                        title="Already applied - matches current assignment">
                                        <i class="fas fa-check me-1"></i>Applied
                                    </button>
                                {% else %}
                                    <button type="button" class="btn btn-outline-success btn-sm apply-payoree-suggestion"
                                        data-payoree-id="{{ payoree_suggestion.id }}"
                                        title="Apply AI payoree suggestion">
                                        <i class="fas fa-arrow-left me-1"></i>Apply
                                    </button>
                                {% endif %}
                            {% else %}
                                <button type="button" class="btn btn-outline-secondary btn-sm" disabled>
                                    <i class="fas fa-clock me-1"></i>No suggestion
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    
                    <!-- Category Row -->
                    <tr class="text-center align-middle" data-field="category">
                        <td><strong>Category</strong></td>
                        <td class="current-value">
                            {% if transaction.category %}
                                <span class="badge {% if category_suggestion and transaction.category.id == category_suggestion.id %}bg-success{% else %}bg-primary{% endif %}">{{ transaction.category.name }}</span>
                            {% else %}
                                <span class="text-muted fst-italic">Not assigned</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if transaction.category %}
                                {% if category_suggestion and transaction.category.id == category_suggestion.id %}
                                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled
                                        title="AI suggestion matches current assignment">
                                        <i class="fas fa-check me-1"></i>Match
                                    </button>
                                {% else %}
                                    <button type="button" class="btn btn-outline-primary btn-sm train-ai-category"
                                        data-transaction-id="{{ transaction.id }}" 
                                        data-category-id="{{ transaction.category.id }}"
                                        title="Teach AI from current category assignment">
                                        <i class="fas fa-arrow-right me-1"></i>Train
                                    </button>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if category_suggestion %}
                                <span class="badge bg-success">{{ category_suggestion.name }}</span>
                            {% else %}
                                <span class="text-muted fst-italic">No suggestion</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if category_suggestion %}
                                {% if transaction.category and transaction.category.id == category_suggestion.id %}
                                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled
                                        title="Already applied - matches current assignment">
                                        <i class="fas fa-check me-1"></i>Applied
                                    </button>
                                {% else %}
                                    <button type="button" class="btn btn-outline-success btn-sm apply-category-suggestion"
                                        data-category-id="{{ category_suggestion.id }}"
                                        {% if subcategory_suggestion %}data-subcategory-id="{{ subcategory_suggestion.id }}"{% endif %}
                                        title="Apply AI category suggestion">
                                        <i class="fas fa-arrow-left me-1"></i>Apply
                                    </button>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    
                    <!-- Subcategory Row -->
                    <tr class="text-center align-middle" data-field="subcategory">
                        <td><strong>Subcategory</strong></td>
                        <td class="current-value">
                            {% if transaction.subcategory %}
                                <span class="badge {% if subcategory_suggestion and transaction.subcategory.id == subcategory_suggestion.id %}bg-success{% else %}bg-secondary{% endif %}">{{ transaction.subcategory.name }}</span>
                            {% else %}
                                <span class="text-muted fst-italic">Not assigned</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if transaction.subcategory %}
                                {% if subcategory_suggestion and transaction.subcategory.id == subcategory_suggestion.id %}
                                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled
                                        title="AI suggestion matches current assignment">
                                        <i class="fas fa-check me-1"></i>Match
                                    </button>
                                {% else %}
                                    <button type="button" class="btn btn-outline-primary btn-sm train-ai-subcategory"
                                        data-transaction-id="{{ transaction.id }}" 
                                        data-subcategory-id="{{ transaction.subcategory.id }}"
                                        title="Teach AI from current subcategory assignment">
                                        <i class="fas fa-arrow-right me-1"></i>Train
                                    </button>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if subcategory_suggestion %}
                                <span class="badge bg-success">{{ subcategory_suggestion.name }}</span>
                            {% else %}
                                <span class="text-muted fst-italic">No suggestion</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if subcategory_suggestion %}
                                {% if transaction.subcategory and transaction.subcategory.id == subcategory_suggestion.id %}
                                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled
                                        title="Already applied - matches current assignment">
                                        <i class="fas fa-check me-1"></i>Applied
                                    </button>
                                {% else %}
                                    <button type="button" class="btn btn-outline-success btn-sm apply-subcategory-suggestion"
                                        data-subcategory-id="{{ subcategory_suggestion.id }}"
                                        title="Apply AI subcategory suggestion">
                                        <i class="fas fa-arrow-left me-1"></i>Apply
                                    </button>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- AI Reasoning and Confidence Section -->
        {% if ai_reasoning or confidence_data %}
        <div class="container-fluid p-2 bg-light rounded mt-3">
            <div class="row">
                {% if ai_reasoning %}
                <div class="col">
                    <small class="text-muted fw-bold">AI Reasoning:</small><br>
                    <small class="text-secondary">{{ ai_reasoning }}</small>
                </div>
                {% endif %}
                
                {% if category_suggestion and confidence_data %}
                <div class="col-auto">
                    <small class="text-muted fw-bold me-2">AI Confidence:</small>
                    <div class="progress mt-1" style="width: 120px; height: 12px;">
                        <div class="progress-bar {% if confidence_data.overall_confidence >= 80 %}bg-success{% elif confidence_data.overall_confidence >= 60 %}bg-warning{% else %}bg-secondary{% endif %}" 
                             role="progressbar" 
                             style="width: {{ confidence_data.overall_confidence }}%"
                             aria-valuenow="{{ confidence_data.overall_confidence }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    <small class="text-muted">{{ confidence_data.overall_confidence }}%</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}