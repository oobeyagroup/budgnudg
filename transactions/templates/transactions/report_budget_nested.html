{# templates/transactions/report_budget_nested.html #}
{% extends "base.html" %}
{% load custom_filters %}
{% load humanize %}

{% block title %}Budget Report (Nested){% endblock %}

{% block extra_css %}
<style>
    .category-type-row {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        font-weight: bold;
    }
    
    .category-row {
        background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
        color: white;
        font-weight: 600;
    }
    
    .subcategory-row {
        background: linear-gradient(135deg, #198754 0%, #146c43 100%);
        color: white;
        font-weight: 500;
    }
    
    .transaction-row {
        background-color: #f8f9fa;
    }
    
    .transaction-row:hover {
        background-color: #e9ecef;
    }
    
    .collapsible-header {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .collapsible-header:hover {
        opacity: 0.9;
    }
    
    .collapse-icon {
        transition: transform 0.3s ease;
    }
    
    .collapsed .collapse-icon {
        transform: rotate(-90deg);
    }
    
    .sticky-header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .horizontal-scroll {
        overflow-x: auto;
        white-space: nowrap;
    }
    
    .month-header {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        font-weight: 600;
        padding: 0.5rem 0.25rem;
        min-height: 100px;
        min-width: 80px;
    }
    
    .description-cell {
        min-width: 250px;
        max-width: 300px;
        position: sticky;
        left: 0;
        background: inherit;
        z-index: 5;
    }
    
    .amount-cell {
        min-width: 100px;
        position: sticky;
        left: 250px;
        background: inherit;
        z-index: 4;
    }
    
    .count-cell {
        min-width: 80px;
        position: sticky;
        left: 350px;
        background: inherit;
        z-index: 3;
    }
    
    .monthly-column {
        min-width: 80px;
        text-align: right;
        white-space: nowrap;
    }
    
    @media (max-width: 768px) {
        .month-header {
            min-width: 60px;
            min-height: 80px;
        }
        
        .description-cell {
            min-width: 200px;
        }
        
        .amount-cell {
            left: 200px;
        }
        
        .count-cell {
            left: 300px;
        }
    }
</style>
{% endblock %}
{% block content %}
<div class="container-fluid mt-3">
        <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-chart-line me-2 text-primary"></i>
                        Nested Budget Report â€” {{ year }}
                    </h2>
                </div>
                <div class="text-end">
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <div class="text-muted">
                            <strong>{{ total_transactions }}</strong> transactions
                        </div>
                        <div class="text-muted">
                            Total: <span class="currency {% if grand_total_amount >= 0 %}currency-positive{% elif grand_total_amount < 0 %}currency-negative{% else %}currency-zero{% endif %}">{{ grand_total_amount|floatformat:2|intcomma }}</span>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="expandAll()">
                                <i class="fas fa-expand-arrows-alt me-1"></i>Expand All
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="collapseAll()">
                                <i class="fas fa-compress-arrows-alt me-1"></i>Collapse All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead class="table-dark">
        <tr>
          <th style="min-width: 280px;">Row</th>
          {% for m in month_labels %}
            <th class="text-end">{{ m }}</th>
          {% endfor %}
          <th class="text-end">Total</th>
        </tr>
      </thead>
      <tbody>
        {# Top-level rows #}
        {% for node in nodes %}
          {% include "transactions/partials/_report_budget_row.html" with node=node level=0 %}
        {% empty %}
          <tr><td colspan="{{ month_labels|length|add:'2' }}">No data found.</td></tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr class="table-secondary">
          <th>Grand Total</th>
          {# Blank cells to align; leave monthly rollups out or add if you compute them #}
          {% for _ in month_labels %}<th>GT</th>{% endfor %}
          <th class="text-end fw-bold">{{ grand_total }}</th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
<script>
function expandAll() {
    document.querySelectorAll('.collapse').forEach(element => {
        if (!element.classList.contains('show')) {
            const bsCollapse = new bootstrap.Collapse(element, {toggle: false});
            bsCollapse.show();
        }
    });
    
    // Update all chevron icons
    document.querySelectorAll('.collapse-icon').forEach(icon => {
        icon.closest('tr').classList.remove('collapsed');
    });
}

function collapseAll() {
    document.querySelectorAll('.collapse.show').forEach(element => {
        const bsCollapse = new bootstrap.Collapse(element, {toggle: false});
        bsCollapse.hide();
    });
    
    // Update all chevron icons
    document.querySelectorAll('.collapse-icon').forEach(icon => {
        icon.closest('tr').classList.add('collapsed');
    });
}

// Handle collapse icon rotation
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(element => {
        element.addEventListener('click', function() {
            const icon = this.querySelector('.collapse-icon');
            if (icon) {
                // Toggle collapsed class on the row
                this.classList.toggle('collapsed');
            }
        });
        
        // Initialize as collapsed for categories and subcategories
        if (!element.closest('tr').classList.contains('category-type-row')) {
            element.classList.add('collapsed');
        }
    });
});
</script>
{% endblock %}