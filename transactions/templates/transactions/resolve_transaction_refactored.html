{% extends "base.html" %}
{% load static %}

{% block title %}Resolve Transaction{% endblock %}

{% block extra_css %}
<style>
    .sticky-actions {
        position: sticky;
        top: 20px;
        z-index: 1020;
    }
    
    .transaction-form-container {
        min-height: 100vh;
    }
    
    .card-hover:hover {
        transform: translateY(-2px);
        transition: transform 0.2s ease-in-out;
    }
    
    .progress-indicator {
        height: 4px;
        background: linear-gradient(90deg, var(--bs-success) 0%, var(--bs-warning) 50%, var(--bs-danger) 100%);
        border-radius: 2px;
    }
    
    @media (max-width: 768px) {
        .sticky-actions {
            position: relative;
            top: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Progress Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h4 class="mb-1">
                                <i class="fas fa-edit text-primary me-2"></i>
                                Resolve Transaction
                            </h4>
                            <p class="text-muted mb-0">
                                Review and categorize transaction details
                            </p>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-warning me-2">Pending Resolution</span>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="history.back()">
                                <i class="fas fa-arrow-left me-1"></i>Back
                            </button>
                        </div>
                    </div>
                    
                    <!-- Progress Indicator -->
                    <div class="progress-indicator mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <form id="transaction-form" method="post" action="">
        {% csrf_token %}
        
        <div class="row">
            <!-- Left Column: Transaction Details & AI -->
            <div class="col-lg-8 col-xl-9">
                <div class="row">
                    <!-- Transaction Summary -->
                    <div class="col-12">
                        {% include "transactions/partials/_transaction_summary.html" %}
                    </div>
                    
                    <!-- AI Suggestions -->
                    <div class="col-12">
                        {% include "transactions/partials/_ai_suggestions.html" %}
                    </div>
                    
                    <!-- Similar Transactions -->
                    <div class="col-12">
                        {% include "transactions/partials/_similar_transactions.html" %}
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Assignment Forms & Actions -->
            <div class="col-lg-4 col-xl-3">
                <div class="sticky-actions">
                    <!-- Payoree Assignment -->
                    {% include "transactions/partials/_payoree_assignment.html" %}
                    
                    <!-- Category Assignment -->
                    {% include "transactions/partials/_category_assignment.html" %}
                    
                    <!-- Action Buttons -->
                    <div class="card shadow-sm border-success">
                        <div class="card-header bg-success bg-opacity-10">
                            <h6 class="mb-0 text-success-emphasis">
                                <i class="fas fa-check-circle me-2"></i>Complete Resolution
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <!-- Save & Continue Button -->
                                <button type="submit" name="action" value="save_continue" 
                                        class="btn btn-success btn-lg" id="save-continue-btn">
                                    <i class="fas fa-save me-2"></i>
                                    Save & Continue
                                </button>
                                
                                <!-- Save & Return Button -->
                                <button type="submit" name="action" value="save_return" 
                                        class="btn btn-outline-success" id="save-return-btn">
                                    <i class="fas fa-check me-2"></i>
                                    Save & Return to List
                                </button>
                                
                                <!-- Skip Button -->
                                <button type="button" class="btn btn-outline-warning" 
                                        data-url="{% url 'transactions:transactions_list' %}" 
                                        id="skip-button">
                                    <i class="fas fa-forward me-2"></i>
                                    Skip for Now
                                </button>
                            </div>
                            
                            <!-- Form Validation Summary -->
                            <div id="validation-summary" class="mt-3 d-none">
                                <div class="alert alert-warning alert-sm mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span id="validation-message">Please review the highlighted fields</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="card shadow-sm mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-bolt me-2"></i>Quick Actions
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="auto-categorize">
                                    <i class="fas fa-magic me-1"></i>Auto-Categorize
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" id="mark-duplicate">
                                    <i class="fas fa-copy me-1"></i>Mark as Duplicate
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="add-note">
                                    <i class="fas fa-sticky-note me-1"></i>Add Note
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Toast Notifications Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="success-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="success-message">
            Transaction saved successfully!
        </div>
    </div>
    
    <div id="error-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="error-message">
            Please check your input and try again.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize form validation
    const form = document.getElementById('transaction-form');
    const validationSummary = document.getElementById('validation-summary');
    const validationMessage = document.getElementById('validation-message');
    
    // Apply AI suggestion functionality
    document.querySelectorAll('.apply-suggestion, .apply-category').forEach(button => {
        button.addEventListener('click', function() {
            const categoryId = this.dataset.categoryId;
            const subcategoryId = this.dataset.subcategoryId;
            
            // Add loading state
            const originalContent = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Applying...';
            this.disabled = true;
            
            // Apply the suggestion
            setTimeout(() => {
                applySuggestion(categoryId, subcategoryId);
                
                // Reset button state and show feedback
                this.innerHTML = '<i class="fas fa-check me-1"></i>Applied!';
                setTimeout(() => {
                    this.innerHTML = originalContent;
                    this.disabled = false;
                }, 1500);
                
                showToast('success', 'Category suggestion applied successfully!');
            }, 300);
        });
    });
    
    // Auto-categorize functionality
    document.getElementById('auto-categorize').addEventListener('click', function() {
        const button = this;
        const originalContent = button.innerHTML;
        
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
        button.disabled = true;
        
        // Find and apply the first available AI suggestion
        const suggestionButton = document.querySelector('.apply-suggestion');
        if (suggestionButton) {
            suggestionButton.click();
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
            }, 1500);
        } else {
            // Try to get fresh AI suggestions via API
            const transactionId = getTransactionId();
            if (transactionId) {
                fetchAISuggestions(transactionId).then(suggestions => {
                    if (suggestions && suggestions.category) {
                        applySuggestion(suggestions.category.id, suggestions.subcategory?.id);
                        showToast('success', 'AI categorization applied!');
                    } else {
                        showToast('error', 'No AI suggestions available for auto-categorization');
                    }
                }).catch(error => {
                    showToast('error', 'Failed to get AI suggestions');
                }).finally(() => {
                    button.innerHTML = originalContent;
                    button.disabled = false;
                });
            } else {
                showToast('error', 'No AI suggestions available for auto-categorization');
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        }
    });
    
    // Skip button functionality
    document.getElementById('skip-button').addEventListener('click', function() {
        const url = this.dataset.url;
        if (url) {
            location.href = url;
        }
    });
    
    // Form submission with validation
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Basic validation
        const category = document.getElementById('id_category').value;
        const payoree = document.getElementById('id_payoree').value;
        
        if (!category) {
            showValidationError('Please select a category');
            return;
        }
        
        if (!payoree) {
            showValidationError('Please assign a payoree');
            return;
        }
        
        // Hide validation summary if shown
        validationSummary.classList.add('d-none');
        
        // Submit the form
        this.submit();
    });
    
    // Category change handler for subcategory loading
    const categorySelect = document.getElementById('id_category');
    const subcategorySelect = document.getElementById('id_subcategory');
    
    if (categorySelect && subcategorySelect) {
        categorySelect.addEventListener('change', function() {
            const categoryId = this.value;
            if (categoryId) {
                loadSubcategories(categoryId);
            } else {
                subcategorySelect.innerHTML = '<option value="">Select subcategory...</option>';
                subcategorySelect.disabled = true;
            }
        });
    }
    
    // Utility functions
    function showValidationError(message) {
        validationMessage.textContent = message;
        validationSummary.classList.remove('d-none');
        validationSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    function showToast(type, message) {
        const toast = document.getElementById(type + '-toast');
        const messageElement = document.getElementById(type + '-message');
        
        if (toast && messageElement) {
            messageElement.textContent = message;
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
    }
    
    function loadSubcategories(categoryId) {
        fetch(`/transactions/api/subcategories/${categoryId}/`)
            .then(response => response.json())
            .then(data => {
                subcategorySelect.innerHTML = '<option value="">Select subcategory...</option>';
                data.subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.id;
                    option.textContent = sub.name;
                    subcategorySelect.appendChild(option);
                });
                subcategorySelect.disabled = false;
            })
            .catch(error => {
                console.error('Error loading subcategories:', error);
                showToast('error', 'Failed to load subcategories');
            });
    }
    
    // Enhanced utility functions
    function getTransactionId() {
        // Extract transaction ID from URL
        const pathParts = window.location.pathname.split('/');
        const resolveIndex = pathParts.indexOf('resolve');
        if (resolveIndex !== -1 && pathParts[resolveIndex + 1]) {
            return parseInt(pathParts[resolveIndex + 1]);
        }
        return null;
    }
    
    function fetchAISuggestions(transactionId) {
        return fetch(`/transactions/api/suggestions/${transactionId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    return data.suggestions;
                } else {
                    throw new Error(data.error || 'Failed to fetch suggestions');
                }
            });
    }
    
    function applySuggestion(categoryId, subcategoryId) {
        if (categoryId) {
            const categorySelect = document.getElementById('id_category');
            if (categorySelect) {
                categorySelect.value = categoryId;
                categorySelect.dispatchEvent(new Event('change'));
                
                // Apply subcategory after category loads
                if (subcategoryId) {
                    setTimeout(() => {
                        const subcategorySelect = document.getElementById('id_subcategory');
                        if (subcategorySelect) {
                            subcategorySelect.value = subcategoryId;
                        }
                    }, 500);
                }
            }
        }
    }
    
    function loadMoreSimilarTransactions() {
        const transactionId = getTransactionId();
        if (!transactionId) return;
        
        const button = document.querySelector('.load-more-similar');
        if (button) {
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
            button.disabled = true;
        }
        
        fetch(`/transactions/api/similar/${transactionId}/?limit=10`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update similar transactions section with new data
                    updateSimilarTransactionsTable(data.transactions);
                    showToast('success', `Loaded ${data.transactions.length} similar transactions`);
                } else {
                    showToast('error', 'Failed to load more similar transactions');
                }
            })
            .catch(error => {
                console.error('Error loading similar transactions:', error);
                showToast('error', 'Failed to load similar transactions');
            })
            .finally(() => {
                if (button) {
                    button.innerHTML = '<i class="fas fa-plus me-1"></i>Load More Similar Transactions';
                    button.disabled = false;
                }
            });
    }
    
    function updateSimilarTransactionsTable(transactions) {
        // This would update the similar transactions table with fresh data
        // Implementation depends on how you want to handle the UI update
        console.log('Updating similar transactions:', transactions);
    }
    
    // Progressive disclosure for mobile
    if (window.innerWidth < 768) {
        const actionCard = document.querySelector('.sticky-actions');
        if (actionCard) {
            actionCard.style.position = 'relative';
            actionCard.style.top = 'auto';
        }
    }
});
</script>
{% endblock %}
