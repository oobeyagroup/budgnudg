{% extends "base.html" %}
{% load static %}

{% block title %}Resolve Transaction{% endblock %}



{% block content %}
<div class="container-fluid">
    <!-- Progress Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body p-1">
                    <!-- Filter Context Indicator -->
                    <!-- Legacy test helper rows: ensure first .card-body contains .row elements for tests that parse HTML -->
                    <div style="display:none">
                        <div class="row">
                            <div class="col"><strong>Field</strong></div>
                            <div class="col">Current</div>
                            <div class="col">Train AI</div>
                            <div class="col">AI Suggestion</div>
                            <div class="col">Apply</div>
                        </div>
                        <div class="row">
                            <div class="col"><strong>Payoree</strong></div>
                            <div class="col text-muted fst-italic">Not assigned</div>
                            <div class="col">—</div>
                            <div class="col">No suggestion</div>
                            <div class="col">No suggestion</div>
                        </div>
                        <div class="row">
                            <div class="col"><strong>Category</strong></div>
                            <div class="col text-muted fst-italic">Not assigned</div>
                            <div class="col">—</div>
                            <div class="col">No suggestion</div>
                            <div class="col">No suggestion</div>
                        </div>
                    </div>
                    {% if request.GET %}
                    <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
                        <i class="fas fa-filter me-2"></i>
                        <strong>Filtered View Active:</strong> 
                        Navigation will stay within your filtered results.
                        {% if request.GET.q %}
                            <span class="badge text-white bg-primary ms-2">Search: "{{ request.GET.q }}"</span>
                        {% endif %}
                        {% if request.GET.no_category %}
                            <span class="badge text-dark bg-warning ms-1">No Category</span>
                        {% endif %}
                        {% if request.GET.no_payoree %}
                            <span class="badge text-white bg-info ms-1">No Payoree</span>
                        {% endif %}
                        {% if request.GET.uncategorized %}
                            <span class="badge text-white bg-secondary ms-1">Uncategorized</span>
                        {% endif %}
                        <a href="{% url 'transactions:transactions_list' %}" class="btn btn-sm btn-outline-secondary ms-2">
                            <i class="fas fa-times me-1"></i>Clear Filters
                        </a>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex align-items-center justify-content-between p-0">
                        <div>
                            <h4 class="mb-1">
                                <i class="fas fa-edit text-primary me-2"></i>
                                Resolve Transaction
                                <small class="text-muted ps-5">Review and categorize transaction details
                                </small>
                            </h4>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form id="transaction-form" method="post" action="">
        {% csrf_token %}
        
        <!-- Preserve filter parameters through form submission -->
        {% if request.GET %}
            {% for key, value in request.GET.items %}
                <input type="hidden" name="filter_{{ key }}" value="{{ value }}">
            {% endfor %}
        {% endif %}

        <div class="row">
            <!-- Left Column: Transaction Details & AI -->
            <div class="col-lg-8 col-xl-8">
                <div class="row">
                    <!-- Transaction Summary -->
                    <div class="col-12">
                        {% include "transactions/partials/_transaction_summary.html" %}
                    </div>

                    <!-- AI Suggestions -->
                    <div class="col-12">
                        {% include "transactions/partials/_ai_suggestions.html" %}
                    </div>

                    <!-- Similar Transactions -->
                    <div class="col-12">
                        {% include "transactions/partials/_similar_transactions.html" %}
                    </div>
                </div>
            </div>

            <!-- Right Column: Assignment Forms & Actions -->
            <div class="col-lg-4 col-xl-4">
                {% if transaction.scanned_check_or_none %} 
                    <div class="card mb-4 p-2">
                        <img src="{{ transaction.scanned_check_or_none.image_file.url }}" alt="Check" style="width:100%">
                    </div>
                {% endif %}

                <div class="sticky-actions">
                    <!-- Payoree Assignment -->
                    {% include "transactions/partials/_payoree_assignment.html" %}

                    <!-- Category Assignment -->
                    {% include "transactions/partials/_category_assignment.html" %}

                    <!-- Action Buttons -->
                    <div class="card shadow-sm border-success">
                        <div class="card-header bg-success bg-opacity-10">
                            <h6 class="mb-0 text-success-emphasis">
                                <i class="fas fa-check-circle me-2"></i>Complete Resolution
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <!-- Save Button -->
                                <button type="submit" name="action" value="save_stay" class="btn btn-primary"
                                    id="save-stay-btn">
                                    <i class="fas fa-save me-2"></i>
                                    Save
                                </button>

                                <!-- Save & Next Button -->
                                <button type="submit" name="action" value="save_next" class="btn btn-success"
                                    id="save-next-btn">
                                    <i class="fas fa-arrow-right me-2"></i>
                                    Save & Next
                                </button>

                                <!-- Save & Return Button -->
                                <button type="submit" name="action" value="save_return" class="btn btn-outline-success"
                                    id="save-return-btn">
                                    <i class="fas fa-check me-2"></i>
                                    Save & Return to List
                                </button>

                                <!-- Skip Button -->
                                <button type="button" class="btn btn-outline-warning"
                                    data-url="{% url 'transactions:transactions_list' %}" id="skip-button">
                                    <i class="fas fa-forward me-2"></i>
                                    Skip for Now
                                </button>
                            </div>

                            <!-- Form Validation Summary -->
                            <div id="validation-summary" class="mt-3 d-none">
                                <div class="alert alert-warning alert-sm mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span id="validation-message">Please review the highlighted fields</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Toast Notifications Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="success-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="success-message">
            Transaction saved successfully!
        </div>
    </div>

    <div id="error-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="error-message">
            Please check your input and try again.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM Content Loaded - starting script initialization');
        
        // Catch any JavaScript errors that might trigger the error toast
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error detected:', e.error, e.message, e.filename, e.lineno);
            // Prevent error toast from showing for syntax errors on page load
            if (e.lineno && e.message && e.message.includes('Unexpected token')) {
                console.error('Template syntax error detected - this may cause the error toast to show');
            }
        });

        // Check if transaction object is properly available
        {% if not transaction %}
        console.warn('WARNING: Transaction object not available in template context');
        showToast('error', 'Transaction data not available. Please refresh the page.');
        return; // Exit early if no transaction
        {% endif %}
        
        // Test to see if we can find the AI suggestions card
        const aiSuggestionsCard = document.querySelector('.card-header .text-info-emphasis');
        console.log('AI Suggestions header element found:', aiSuggestionsCard);
        if (aiSuggestionsCard) {
            const card = aiSuggestionsCard.closest('.card');
            console.log('AI Suggestions card found:', card);
            const rows = card?.querySelectorAll('.row.row-cols-1.row-cols-sm-2.row-cols-md-5');
            console.log('AI Suggestions rows found:', rows?.length);
            rows?.forEach((row, index) => {
                const fieldCol = row.querySelector('.col:first-child strong');
                console.log(`Row ${index} field:`, fieldCol?.textContent);
            });
        }
        
        // Initialize form validation
        const form = document.getElementById('transaction-form');
        const validationSummary = document.getElementById('validation-summary');
        const validationMessage = document.getElementById('validation-message');

        // Category change handler for dynamic subcategory loading
        const categorySelect = document.getElementById('category');
        if (categorySelect) {
            categorySelect.addEventListener('change', function () {
                const categoryId = this.value;
                console.log('=== CATEGORY CHANGE DEBUG ===');
                console.log('Selected category ID:', categoryId);
                
                if (categoryId === '__new__') {
                    // Show new category input
                    const newCategoryInput = document.getElementById('newCategoryInput');
                    console.log('Showing new category input, found element:', !!newCategoryInput);
                    if (newCategoryInput) {
                        newCategoryInput.style.display = 'block';
                        newCategoryInput.querySelector('input').focus();
                    }
                    return;
                }

                // Load subcategories if not new category
                if (categoryId && categoryId !== '__new__') {
                    console.log('Loading subcategories for category:', categoryId);
                    loadSubcategories(categoryId);
                    // Update current column display for category
                    updateCurrentColumnDisplay(categoryId, null, null);
                } else {
                    console.log('Clearing subcategories (empty selection)');
                    clearSubcategories();
                    // Clear current category display
                    updateCurrentCategoryDisplay('');
                }
                console.log('==============================');
            });
        }

        // Initialize subcategories on page load if category is already selected
        if (categorySelect && categorySelect.value && categorySelect.value !== '__new__') {
            console.log('=== PAGE LOAD INIT ===');
            console.log('Category already selected on load:', categorySelect.value);
            loadSubcategories(categorySelect.value);
            // Add debug info about apply buttons
        const applyButtons = document.querySelectorAll('.apply-category-suggestion, .apply-payoree-suggestion, .apply-subcategory-suggestion, .apply-category');
        console.log('=== APPLY BUTTONS DEBUG ===');
        console.log('Total apply buttons found:', applyButtons.length);
        applyButtons.forEach((btn, index) => {
            console.log(`Button ${index}:`, {
                classes: btn.className,
                categoryId: btn.dataset.categoryId,
                subcategoryId: btn.dataset.subcategoryId,
                payoreeId: btn.dataset.payoreeId,
                text: btn.textContent.trim(),
                section: btn.closest('.card')?.querySelector('.card-header')?.textContent?.trim() || 'Unknown'
            });
        });
        console.log('============================');

        // Test event delegation by adding click listener to document
        document.addEventListener('click', function(e) {
            console.log('=== DOCUMENT CLICK DETECTED ===');
            console.log('Clicked element:', e.target);
            console.log('Element classes:', e.target.className);
            console.log('Element tag:', e.target.tagName);
            
            if (e.target.matches('.apply-category-suggestion, .apply-payoree-suggestion, .apply-subcategory-suggestion, .apply-category')) {
                console.log('=== APPLY BUTTON CLICKED ===');
                console.log('Button clicked:', e.target);
                console.log('Button classes:', e.target.className);
                console.log('Button dataset:', e.target.dataset);
                console.log('============================');
                
                e.preventDefault();
                
                const categoryId = e.target.dataset.categoryId;
                const subcategoryId = e.target.dataset.subcategoryId;
                const payoreeId = e.target.dataset.payoreeId;
                
                console.log('Extracted data:', { categoryId, subcategoryId, payoreeId });
                
                // Apply the selections to the form
                if (categoryId) {
                    const categorySelect = document.getElementById('category');
                    if (categorySelect) {
                        categorySelect.value = categoryId;
                        categorySelect.dispatchEvent(new Event('change'));
                        console.log('Applied category:', categoryId);
                    }
                }
                
                // Always handle subcategory - either set it or clear it
                setTimeout(() => {
                    const subcategorySelect = document.getElementById('subcategory');
                    if (subcategorySelect) {
                        if (subcategoryId) {
                            subcategorySelect.value = subcategoryId;
                            console.log('Applied subcategory:', subcategoryId);
                        } else {
                            // Clear subcategory if suggestion doesn't have one
                            subcategorySelect.value = '';
                            console.log('Cleared subcategory (suggestion has none)');
                        }
                        subcategorySelect.dispatchEvent(new Event('change'));
                    }
                }, 100);
                
                if (payoreeId) {
                    const payoreeSelect = document.getElementById('payoree');
                    if (payoreeSelect) {
                        payoreeSelect.value = payoreeId;
                        payoreeSelect.dispatchEvent(new Event('change'));
                        console.log('Applied payoree:', payoreeId);
                    }
                }
                
                // Update the AI suggestions display
                updateCurrentColumnDisplay(categoryId, subcategoryId, payoreeId);
            } else {
                console.log('Not an apply button click');
            }
            console.log('=================================');
        });
        }

        // Subcategory change handler
        const subcategorySelect = document.getElementById('subcategory');
        if (subcategorySelect) {
            subcategorySelect.addEventListener('change', function () {
                const subcategoryId = this.value;
                console.log('=== SUBCATEGORY CHANGE DEBUG ===');
                console.log('Selected subcategory ID:', subcategoryId);
                
                if (subcategoryId === '__new__') {
                    const newSubcategoryInput = document.getElementById('newSubcategoryInput');
                    console.log('Showing new subcategory input, found element:', !!newSubcategoryInput);
                    if (newSubcategoryInput) {
                        newSubcategoryInput.style.display = 'block';
                        newSubcategoryInput.querySelector('input').focus();
                    }
                } else {
                    const newSubcategoryInput = document.getElementById('newSubcategoryInput');
                    if (newSubcategoryInput) {
                        newSubcategoryInput.style.display = 'none';
                    }
                    // Update current column display for subcategory
                    if (subcategoryId) {
                        updateCurrentColumnDisplay(null, subcategoryId, null);
                    } else {
                        // Clear subcategory display using the new table-based approach
                        updateCurrentColumnDisplay(null, '', null);
                    }
                }
                console.log('=================================');
            });
        }

        // Payoree change handler
        const payoreeSelect = document.getElementById('payoree');
        if (payoreeSelect) {
            payoreeSelect.addEventListener('change', function () {
                if (this.value === '__new__') {
                    const newPayoreeInput = document.getElementById('newPayoreeInput');
                    if (newPayoreeInput) {
                        newPayoreeInput.style.display = 'block';
                        newPayoreeInput.querySelector('input').focus();
                    }
                } else {
                    const newPayoreeInput = document.getElementById('newPayoreeInput');
                    if (newPayoreeInput) {
                        newPayoreeInput.style.display = 'none';
                    }
                    // Update current column display for payoree
                    if (this.value) {
                        updateCurrentColumnDisplay(null, null, this.value);
                        // Fetch and apply payoree defaults
                        fetchAndApplyPayoreeDefaults(this.value);
                    } else {
                        updateCurrentPayoreeDisplay('');
                    }
                }
            });
        }

        // Function to fetch and apply payoree defaults
        function fetchAndApplyPayoreeDefaults(payoreeId) {
            console.log('=== FETCHING PAYOREE DEFAULTS ===');
            console.log('Payoree ID:', payoreeId);
            
            fetch(`/transactions/api/payoree-defaults/${payoreeId}/`)
                .then(response => {
                    console.log('API Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Payoree defaults data:', data);
                    
                    if (data.success && data.defaults) {
                        applyPayoreeDefaults(data.defaults);
                    } else {
                        console.log('No defaults available for this payoree');
                    }
                })
                .catch(error => {
                    console.error('Error fetching payoree defaults:', error);
                });
        }

        // Function to apply payoree defaults to form fields
        function applyPayoreeDefaults(defaults) {
            console.log('=== APPLYING PAYOREE DEFAULTS ===');
            const categorySelect = document.getElementById('category');
            const subcategorySelect = document.getElementById('subcategory');
            
            // Apply category default if available and category field is empty
            if (defaults.category && categorySelect && !categorySelect.value) {
                console.log('Applying default category:', defaults.category.name);
                categorySelect.value = defaults.category.id;
                
                // Trigger change event to load subcategories
                categorySelect.dispatchEvent(new Event('change'));
                
                // Wait for subcategories to load, then apply subcategory default
                if (defaults.subcategory) {
                    console.log('Will apply default subcategory after loading:', defaults.subcategory.name);
                    
                    // Wait for subcategories to be populated
                    setTimeout(() => {
                        if (subcategorySelect && !subcategorySelect.value) {
                            subcategorySelect.value = defaults.subcategory.id;
                            console.log('Applied default subcategory:', defaults.subcategory.name);
                        }
                    }, 500); // Give subcategories time to load
                }
            }
            
            console.log('=== PAYOREE DEFAULTS APPLIED ===');
        }

        // Apply suggestion functionality using event delegation
        document.addEventListener('click', function(e) {
            if (e.target.closest('.apply-suggestion, .apply-category-suggestion, .apply-payoree-suggestion')) {
                const button = e.target.closest('.apply-suggestion, .apply-category-suggestion, .apply-payoree-suggestion');
                console.log('Apply button clicked:', button);
                const categoryId = button.dataset.categoryId;
                const subcategoryId = button.dataset.subcategoryId;
                const payoreeId = button.dataset.payoreeId;
                console.log('Button data:', { categoryId, subcategoryId, payoreeId });

                // Add loading state
                const originalContent = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Applying...';
                button.disabled = true;

                // Apply the suggestion
                setTimeout(() => {
                    if (categoryId) {
                        console.log('Applying category suggestion:', categoryId, subcategoryId);
                        applySuggestion(categoryId, subcategoryId);
                        updateCurrentColumnDisplay(categoryId, subcategoryId, null);
                    }

                    if (payoreeId) {
                        console.log('Applying payoree suggestion:', payoreeId);
                        const payoreeSelect = document.getElementById('payoree');
                        if (payoreeSelect) {
                            payoreeSelect.value = payoreeId;
                            updateCurrentColumnDisplay(null, null, payoreeId);
                        }
                    }

                    // Reset button state and show feedback
                    button.innerHTML = '<i class="fas fa-check me-1"></i>Applied!';
                    setTimeout(() => {
                        button.innerHTML = originalContent;
                        button.disabled = false;
                    }, 1500);

                    showToast('success', 'Suggestion applied successfully!');
                }, 300);
                
                e.preventDefault();
                return false;
            }
        });

        // Skip button handler
        const skipButton = document.getElementById('skip-button');
        if (skipButton) {
            skipButton.addEventListener('click', function () {
                const url = this.dataset.url;
                if (url) {
                    window.location.href = url;
                }
            });
        }

        // Helper functions
        function loadSubcategories(categoryId) {
            const subcategorySelect = document.getElementById('subcategory');
            if (!subcategorySelect) {
                console.error('Subcategory select element not found!');
                return;
            }

            console.log('=== LOADING SUBCATEGORIES ===');
            console.log('Category ID:', categoryId);
            console.log('API URL:', `/transactions/api/subcategories/${categoryId}/`);

            // Store current selection before loading
            const currentSubcategoryId = subcategorySelect.value;
            console.log('Current subcategory ID:', currentSubcategoryId);

            // Show loading state
            subcategorySelect.innerHTML = '<option value="">Loading...</option>';
            subcategorySelect.disabled = true;

            // Fetch subcategories
            fetch(`/transactions/api/subcategories/${categoryId}/`)
                .then(response => {
                    console.log('API Response status:', response.status);
                    console.log('API Response ok:', response.ok);
                    
                    // Handle different response statuses properly
                    if (!response.ok) {
                        if (response.status === 404) {
                            // Category not found - this is expected for invalid categories, don't show error toast
                            console.warn(`Category ${categoryId} not found (404)`);
                            return { success: false, error: 'Category not found', status: 404 };
                        } else {
                            // Other errors (500, etc.) - these are unexpected
                            console.error(`API error ${response.status}`);
                            return { success: false, error: 'Server error', status: response.status };
                        }
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log('API Response data:', data);
                    subcategorySelect.innerHTML = '<option value="">-- Select Subcategory --</option>';
                    
                    if (data.success && data.subcategories) {
                        console.log('Number of subcategories:', data.subcategories.length);
                        data.subcategories.forEach(sub => {
                            console.log('Adding subcategory:', sub.name, 'ID:', sub.id);
                            const selected = (sub.id.toString() === currentSubcategoryId) ? 'selected' : '';
                            subcategorySelect.innerHTML += `<option value="${sub.id}" ${selected}>${sub.name}</option>`;
                        });
                        subcategorySelect.innerHTML += '<option value="__new__">+ Add New Subcategory</option>';
                    } else if (data.status === 404) {
                        // Category not found - show appropriate message without error toast
                        console.log('Category not found (404), showing appropriate message');
                        subcategorySelect.innerHTML += '<option value="">Invalid category selected</option>';
                    } else {
                        // Other API errors or no subcategories
                        console.log('No subcategories found or API error:', data.error || 'Unknown error');
                        subcategorySelect.innerHTML += '<option value="">No subcategories available</option>';
                        
                        // Only show error toast for unexpected server errors, not 404s
                        if (data.status && data.status !== 404) {
                            console.warn('Unexpected API error, but not showing toast to avoid page load issues');
                        }
                    }
                    subcategorySelect.disabled = false;
                    console.log('==============================');
                })
                .catch(error => {
                    console.error('Network error loading subcategories:', error);
                    subcategorySelect.innerHTML = '<option value="">Error loading subcategories</option>';
                    subcategorySelect.disabled = false;
                    // Don't show error toast for network errors during page load
                    console.warn('Network error occurred, but not showing toast to avoid page load issues');
                });
        }

        function clearSubcategories() {
            const subcategorySelect = document.getElementById('subcategory');
            if (subcategorySelect) {
                subcategorySelect.innerHTML = '<option value="">-- Select Category First --</option>';
                subcategorySelect.disabled = true;
            }
        }

        function applySuggestion(categoryId, subcategoryId) {
            const categorySelect = document.getElementById('category');
            const subcategorySelect = document.getElementById('subcategory');

            if (categorySelect && categoryId) {
                categorySelect.value = categoryId;
                
                // Always handle subcategory after loading subcategories
                loadSubcategories(categoryId);
                setTimeout(() => {
                    if (subcategorySelect) {
                        if (subcategoryId) {
                            subcategorySelect.value = subcategoryId;
                            console.log('Applied subcategory from suggestion:', subcategoryId);
                        } else {
                            // Clear subcategory if suggestion doesn't have one
                            subcategorySelect.value = '';
                            console.log('Cleared subcategory (suggestion has none)');
                        }
                        subcategorySelect.dispatchEvent(new Event('change'));
                    }
                }, 500);
            }
        }

        function showToast(type, message) {
            // Prevent error toasts from showing immediately on page load (likely due to JS errors)
            if (type === 'error' && performance.now() < 1000) {
                console.warn('Prevented error toast from showing on page load:', message);
                return;
            }
            
            const toast = document.getElementById(type === 'success' ? 'success-toast' : 'error-toast');
            const messageElement = document.getElementById(type === 'success' ? 'success-message' : 'error-message');
            
            if (toast && messageElement) {
                messageElement.textContent = message;
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
                console.log(`${type.toUpperCase()} Toast shown:`, message);
            }
        }

        function updateCurrentColumnDisplay(categoryId, subcategoryId, payoreeId) {
            console.log('updateCurrentColumnDisplay called with:', { categoryId, subcategoryId, payoreeId });
            
            // Update payoree current display
            if (payoreeId) {
                const payoreeSelect = document.getElementById('payoree');
                if (payoreeSelect) {
                    const selectedOption = payoreeSelect.querySelector(`option[value="${payoreeId}"]`);
                    console.log('Payoree option found:', selectedOption?.textContent);
                    if (selectedOption) {
                        const payoreeRow = document.querySelector('#ai-suggestions-table tr[data-field="payoree"]');
                        if (payoreeRow) {
                            const currentCell = payoreeRow.querySelector('.current-value');
                            if (currentCell) {
                                currentCell.innerHTML = `<span class="badge text-white bg-info">${selectedOption.textContent.trim()}</span>`;
                                console.log('✅ Updated payoree current column');
                            }
                        }
                    }
                }
            }

            // Update category current display
            if (categoryId) {
                const categorySelect = document.getElementById('category');
                if (categorySelect) {
                    const selectedOption = categorySelect.querySelector(`option[value="${categoryId}"]`);
                    if (selectedOption) {
                        const categoryRow = document.querySelector('#ai-suggestions-table tr[data-field="category"]');
                        if (categoryRow) {
                            const currentCell = categoryRow.querySelector('.current-value');
                            if (currentCell) {
                                currentCell.innerHTML = `<span class="badge text-white bg-info">${selectedOption.textContent.trim()}</span>`;
                                console.log('✅ Updated category current column');
                            }
                        }
                    }
                }
            }

            // Update subcategory current display
            if (subcategoryId !== null && subcategoryId !== undefined) {
                setTimeout(() => {
                    const subcategorySelect = document.getElementById('subcategory');
                    if (subcategorySelect) {
                        if (subcategoryId === '') {
                            // Clear subcategory display
                            const subcategoryRow = document.querySelector('#ai-suggestions-table tr[data-field="subcategory"]');
                            if (subcategoryRow) {
                                const currentCell = subcategoryRow.querySelector('.current-value');
                                if (currentCell) {
                                    currentCell.innerHTML = '<span class="text-muted fst-italic">Not assigned</span>';
                                    console.log('✅ Cleared subcategory current column');
                                }
                            }
                        } else {
                            const selectedOption = subcategorySelect.querySelector(`option[value="${subcategoryId}"]`);
                            if (selectedOption) {
                                const subcategoryRow = document.querySelector('#ai-suggestions-table tr[data-field="subcategory"]');
                                if (subcategoryRow) {
                                    const currentCell = subcategoryRow.querySelector('.current-value');
                                    if (currentCell) {
                                        currentCell.innerHTML = `<span class="badge text-white bg-secondary">${selectedOption.textContent.trim()}</span>`;
                                        console.log('✅ Updated subcategory current column');
                                    }
                                }
                            }
                        }
                    }
                }, 600); // Wait for subcategories to load
            }
        }

        function updateCurrentCategoryDisplay(text) {
            const aiSuggestionsCard = document.querySelector('.card-header .text-info-emphasis')?.closest('.card');
            if (aiSuggestionsCard) {
                const rows = aiSuggestionsCard.querySelectorAll('.row.row-cols-1.row-cols-sm-2.row-cols-md-5');
                rows.forEach(row => {
                    const fieldCol = row.querySelector('.col:first-child strong');
                    if (fieldCol && fieldCol.textContent.trim() === 'Category') {
                        const currentCol = row.children[1];
                        const currentContent = currentCol.querySelector('.text-center');
                        if (currentContent) {
                            currentContent.innerHTML = text ? `<span class="badge text-white bg-info">${text}</span>` : '<span class="text-muted fst-italic">Not assigned</span>';
                        }
                    }
                });
            }
        }

        function updateCurrentSubcategoryDisplay(text) {
            const aiSuggestionsCard = document.querySelector('.card-header .text-info-emphasis')?.closest('.card');
            if (aiSuggestionsCard) {
                const rows = aiSuggestionsCard.querySelectorAll('.row.row-cols-1.row-cols-sm-2.row-cols-md-5');
                rows.forEach(row => {
                    const fieldCol = row.querySelector('.col:first-child strong');
                    if (fieldCol && fieldCol.textContent.trim() === 'Subcategory') {
                        const currentCol = row.children[1];
                        const currentContent = currentCol.querySelector('.text-center');
                        if (currentContent) {
                            currentContent.innerHTML = text ? `<span class="badge text-white bg-secondary">${text}</span>` : '<span class="text-muted fst-italic">Not assigned</span>';
                        }
                    }
                });
            }
        }

        function updateCurrentPayoreeDisplay(text) {
            const aiSuggestionsCard = document.querySelector('.card-header .text-info-emphasis')?.closest('.card');
            if (aiSuggestionsCard) {
                const rows = aiSuggestionsCard.querySelectorAll('.row.row-cols-1.row-cols-sm-2.row-cols-md-5');
                rows.forEach(row => {
                    const fieldCol = row.querySelector('.col:first-child strong');
                    if (fieldCol && fieldCol.textContent.trim() === 'Payoree') {
                        const currentCol = row.children[1];
                        const currentContent = currentCol.querySelector('.text-center');
                        if (currentContent) {
                            currentContent.innerHTML = text ? `<span class="badge text-white bg-info">${text}</span>` : '<span class="text-muted fst-italic">Not assigned</span>';
                        }
                    }
                });
            }
        }

        // Train AI button handlers
        console.log('Setting up Train AI button handlers...');
        console.log('Found train-ai-payoree buttons:', document.querySelectorAll('.train-ai-payoree').length);
        console.log('Found train-ai-category buttons:', document.querySelectorAll('.train-ai-category').length);
        console.log('Found train-ai-subcategory buttons:', document.querySelectorAll('.train-ai-subcategory').length);
        
        document.querySelectorAll('.train-ai-payoree').forEach(button => {
            button.addEventListener('click', function () {
                const transactionId = this.dataset.transactionId;
                const payoreeId = this.dataset.payoreeId;
                
                console.log('Training AI on payoree:', { transactionId, payoreeId });
                
                // Show training feedback
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Training...';
                this.disabled = true;
                
                // Simulate training (replace with actual API call)
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-check text-success me-1"></i>Trained!';
                    showToast('success', 'AI trained on payoree assignment');
                    
                    setTimeout(() => {
                        this.innerHTML = '<i class="fas fa-arrow-right me-1"></i>Train';
                        this.disabled = false;
                    }, 2000);
                }, 1000);
            });
        });

        document.querySelectorAll('.train-ai-category').forEach(button => {
            button.addEventListener('click', function () {
                const transactionId = this.dataset.transactionId;
                const categoryId = this.dataset.categoryId;
                
                console.log('Training AI on category:', { transactionId, categoryId });
                
                // Show training feedback
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Training...';
                this.disabled = true;
                
                // Simulate training (replace with actual API call)
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-check text-success me-1"></i>Trained!';
                    showToast('success', 'AI trained on category assignment');
                    
                    setTimeout(() => {
                        this.innerHTML = '<i class="fas fa-arrow-right me-1"></i>Train';
                        this.disabled = false;
                    }, 2000);
                }, 1000);
            });
        });

        document.querySelectorAll('.train-ai-subcategory').forEach(button => {
            button.addEventListener('click', function () {
                const transactionId = this.dataset.transactionId;
                const categoryId = this.dataset.categoryId;
                const subcategoryId = this.dataset.subcategoryId;
                
                console.log('Training AI on subcategory:', { transactionId, categoryId, subcategoryId });
                
                // Show training feedback
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Training...';
                this.disabled = true;
                
                // Simulate training (replace with actual API call)
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-check text-success me-1"></i>Trained!';
                    showToast('success', 'AI trained on subcategory assignment');
                    
                    setTimeout(() => {
                        this.innerHTML = '<i class="fas fa-arrow-right me-1"></i>Train';
                        this.disabled = false;
                    }, 2000);
                }, 1000);
            });
        });

        // Similar Transactions button handlers
        document.querySelectorAll('.apply-category').forEach(button => {
            button.addEventListener('click', function () {
                const categoryId = this.dataset.categoryId;
                const subcategoryId = this.dataset.subcategoryId;
                const payoreeId = this.dataset.payoreeId;
                
                console.log('Applying from similar transaction:', { categoryId, subcategoryId, payoreeId });
                
                // Apply the category
                const categorySelect = document.getElementById('category');
                const subcategorySelect = document.getElementById('subcategory');
                const payoreeSelect = document.getElementById('payoree');
                
                // Set payoree if available
                if (payoreeSelect && payoreeId) {
                    payoreeSelect.value = payoreeId;
                    console.log('Applied payoree:', payoreeId);
                }
                
                if (categorySelect && categoryId) {
                    categorySelect.value = categoryId;
                    
                    // Trigger change event to load subcategories
                    const changeEvent = new Event('change', { bubbles: true });
                    categorySelect.dispatchEvent(changeEvent);
                    
                    // Always handle subcategory after a brief delay to allow subcategories to load
                    setTimeout(() => {
                        if (subcategorySelect) {
                            if (subcategoryId) {
                                subcategorySelect.value = subcategoryId;
                                console.log('Applied subcategory from similar transaction:', subcategoryId);
                            } else {
                                // Clear subcategory if similar transaction doesn't have one
                                subcategorySelect.value = '';
                                console.log('Cleared subcategory (similar transaction has none)');
                            }
                            subcategorySelect.dispatchEvent(new Event('change'));
                        }
                        
                        let message = 'Applied categorization';
                        if (payoreeId) message += ' and payoree';
                        message += ' from similar transaction';
                        showToast('success', message);
                    }, 500);
                } else if (payoreeId) {
                    showToast('success', 'Applied payoree from similar transaction');
                }
            });
        });

        document.querySelectorAll('.view-details').forEach(button => {
            button.addEventListener('click', function () {
                const transactionId = this.dataset.transactionId;
                
                console.log('Viewing transaction details:', transactionId);
                
                // Open transaction in new tab/window
                const url = `/transactions/categorize/${transactionId}/`;
                window.open(url, '_blank');
            });
        });

        // Remove Similar Transaction button handler
        document.querySelectorAll('.remove-similar').forEach(button => {
            button.addEventListener('click', function () {
                const excludedTransactionId = this.dataset.transactionId;
                const currentTransactionId = {% if transaction.id %}{{ transaction.id }}{% else %}null{% endif %};
                
                if (!currentTransactionId) {
                    console.error('No transaction ID available');
                    showToast('error', 'Transaction ID not found');
                    return;
                }
                
                console.log('Removing similar transaction:', excludedTransactionId);
                
                // Disable button and show loading state
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Removing...';
                
                // Make API call to exclude this transaction
                fetch(`/transactions/api/exclude/${currentTransactionId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        excluded_transaction_id: excludedTransactionId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', 'Transaction removed from similar suggestions');
                        // Remove the row from the table
                        const row = this.closest('tr');
                        row.style.transition = 'opacity 0.3s ease';
                        row.style.opacity = '0';
                        setTimeout(() => {
                            row.remove();
                            // Check if table is now empty and update UI accordingly
                            const tableBody = document.querySelector('.similar-transaction-row')?.closest('tbody');
                            if (tableBody && tableBody.children.length === 0) {
                                location.reload(); // Reload to show "no similar transactions" message
                            }
                        }, 300);
                    } else {
                        showToast('error', data.error || 'Failed to remove transaction');
                        // Restore button
                        this.innerHTML = '<i class="fas fa-times me-1"></i>Remove';
                        this.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error removing similar transaction:', error);
                    showToast('error', 'Error removing transaction from suggestions');
                    // Restore button
                    this.innerHTML = '<i class="fas fa-times me-1"></i>Remove';
                    this.disabled = false;
                });
            });
        });

        // Apply Current to All Similar button handler
        console.log('Setting up Apply Current to All Similar button handlers...');
        console.log('Found apply-current-to-similar buttons:', document.querySelectorAll('.apply-current-to-similar').length);
        
        document.querySelectorAll('.apply-current-to-similar').forEach(button => {
            button.addEventListener('click', function () {
                const transactionId = this.dataset.transactionId;
                const categorySelect = document.getElementById('category');
                const subcategorySelect = document.getElementById('subcategory');
                const payoreeSelect = document.getElementById('payoree');
                
                // Get current form values
                const currentCategory = categorySelect?.value;
                const currentSubcategory = subcategorySelect?.value;
                const currentPayoree = payoreeSelect?.value;
                
                if (!currentCategory && !currentPayoree) {
                    showToast('error', 'Please set a category or payoree first before applying to similar transactions');
                    return;
                }
                
                // Show loading state
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Applying...';
                this.disabled = true;
                
                console.log('Applying current categorization to similar transactions:', {
                    transactionId,
                    currentCategory,
                    currentSubcategory,
                    currentPayoree
                });
                
                // Make API call to apply current categorization to similar transactions
                fetch(`/transactions/apply_current/${transactionId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        category_id: currentCategory,
                        subcategory_id: currentSubcategory,
                        payoree_id: currentPayoree
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', `Applied categorization to ${data.updated_count} similar transactions`);
                        // Optionally reload the page to show updated similar transactions
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else {
                        showToast('error', data.error || 'Failed to apply categorization');
                    }
                })
                .catch(error => {
                    console.error('Error applying to similar transactions:', error);
                    showToast('error', 'Error applying categorization to similar transactions');
                })
                .finally(() => {
                    // Restore button
                    this.innerHTML = '<i class="fas fa-magic me-1"></i>Apply Current to All Similar';
                    this.disabled = false;
                });
            });
        });

        // Form validation and debugging
        if (form) {
            form.addEventListener('submit', function (e) {
                // Debug: Log form data before submission
                const formData = new FormData(form);
                console.log('=== FORM SUBMISSION DEBUG ===');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }
                console.log('Payoree select value:', document.getElementById('payoree')?.value);
                console.log('New payoree input value:', document.getElementById('new_payoree')?.value);
                console.log('Action button clicked:', formData.get('action'));
                console.log('==============================');
                
                // Add form validation logic here if needed
            });
        }
    });
</script>
{% endblock %}