{# templates/transactions/checks_reconcile.html #}
{% extends "base.html" %}
{% block title %}Reconcile Checks{% endblock %}
{% block content %}
<div class="container-fluid mt-3">
  <h2 class="mb-3">Reconcile Checks</h2>

  <form class="row g-2 mb-3" method="get">
    <div class="col-auto">
      <input type="text" name="account" value="{{ account }}" class="form-control" placeholder="Bank account (optional)">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">Filter</button>
    </div>
  </form>

  <div class="row">
    <div class="col-lg-7">
      <h5>Transactions that look like checks</h5>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-dark">
            <tr>
              <th>Date</th><th>Description</th><th>Amount</th><th>Pick</th>
            </tr>
          </thead>
          <tbody>
            {% for t in transactions %}
              {% with num=None %}
                {% if t.description %}
                  {% comment %}Extract number in Python; or compute in view{% endcomment %}
                {% endif %}
              {% endwith %}
              <tr>
                <td class="text-nowrap">{{ t.date|date:"Y-m-d" }}</td>
                <td class="truncate">{{ t.description }}</td>
                <td class="text-nowrap">{{ t.amount }}</td>
                <td>
                  <input type="radio" name="txn_choice" value="{{ t.id }}" form="match-form">
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-muted">No check-like transactions.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="col-lg-5">
      <h5>Unmatched scanned checks</h5>
      <form id="match-form" method="post" action="{% url 'transactions:checks_match' %}">
        {% csrf_token %}
        <div class="row g-3">
          {% for c in checks %}
            <div class="col-12 border rounded p-2">
              <div class="d-flex">
                {% if c.image_file %}
                  <a href="{{ c.image_file.url }}" target="_blank">
                    <img src="{{ c.image_file.url }}" alt="check {{ c.check_number }}" style="width:120px;height:auto" class="me-2 border">
                  </a>
                {% endif %}
                <div>
                  <div><strong>#{{ c.check_number }}</strong> · {{ c.date|default:"—" }} · {{ c.amount|default:"—" }}</div>
                  <div class="text-muted small">{{ c.payee_text }}</div>
                  <div class="mt-2">
                    <input type="radio" name="check_id" value="{{ c.id }}"> Select
                    <button formaction="{% url 'transactions:checks_unlink' c.id %}" formmethod="post" class="btn btn-link btn-sm">
                      {% csrf_token %}Unlink
                    </button>
                  </div>
                  <div class="mt-2 d-flex gap-2">
                    <input name="payee" class="form-control form-control-sm" placeholder="Set payee (optional)" value="">
                    <input name="memo" class="form-control form-control-sm" placeholder="Set memo (optional)" value="">
                  </div>
                </div>
              </div>
            </div>
          {% empty %}
            <div class="text-muted">No scanned checks imported yet.</div>
          {% endfor %}
        </div>
        <div class="mt-3">
          <button class="btn btn-success">Match selected</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}