{% extends 'base.html' %}

{% block title %}Create Budget - {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1>Budget Wizard</h1>
            <p class="text-muted">Create a budget based on your historical spending patterns</p>
        </div>
    </div>
    
    <div id="budget-wizard">
        <!-- Step 1: Configuration -->
        <div class="step-section" id="step-config" style="display: block;">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Configuration</h5>
                        </div>
                        <div class="card-body">
                            <form id="config-form">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="target-months" class="form-label">Budget Duration</label>
                                        <select id="target-months" name="target_months" class="form-select">
                                            <option value="1">1 month</option>
                                            <option value="3" selected>3 months</option>
                                            <option value="6">6 months</option>
                                            <option value="12">12 months</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="calculation-method" class="form-label">Calculation Method</label>
                                        <select id="calculation-method" name="method" class="form-select">
                                            <option value="median" selected>Median (typical spending)</option>
                                            <option value="mean">Average (all spending)</option>
                                            <option value="max">Maximum (high spending)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <label for="starting-year" class="form-label">Starting Year</label>
                                        <select id="starting-year" name="starting_year" class="form-select">
                                            <!-- Will be populated by JavaScript -->
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="starting-month" class="form-label">Starting Month</label>
                                        <select id="starting-month" name="starting_month" class="form-select">
                                            <option value="1">January</option>
                                            <option value="2">February</option>
                                            <option value="3">March</option>
                                            <option value="4">April</option>
                                            <option value="5">May</option>
                                            <option value="6">June</option>
                                            <option value="7">July</option>
                                            <option value="8">August</option>
                                            <option value="9">September</option>
                                            <option value="10">October</option>
                                            <option value="11">November</option>
                                            <option value="12">December</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <button type="button" class="btn btn-primary" onclick="generateDraft()">
                                        <i class="fas fa-magic"></i> Generate Budget Draft
                                    </button>
                                    
                                    <!-- Fallback: Test API via direct link -->
                                    <div class="mt-2">
                                        <a href="{% url 'budgets:api_baseline' %}?target_months=3&method=median&starting_year=2025&starting_month=10" 
                                           target="_blank" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-external-link-alt"></i> Test API Direct
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Tips</h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled small">
                                <li><strong>Median:</strong> Uses typical spending, ignoring outliers</li>
                                <li><strong>Average:</strong> Uses all spending data equally</li>
                                <li><strong>Maximum:</strong> Conservative approach based on highest spending</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Review & Adjust -->
        <div class="step-section" id="step-review" style="display: none;">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Budget Draft</h5>
                            <div>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showStep('config')">
                                    <i class="fas fa-arrow-left"></i> Back to Config
                                </button>
                                <button type="button" class="btn btn-success btn-sm" onclick="commitBudget()">
                                    <i class="fas fa-save"></i> Create Budget
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Summary stats -->
                            <div class="row mb-4" id="budget-summary">
                                <!-- Will be populated by JavaScript -->
                            </div>
                            
                            <!-- Budget items table -->
                            <div class="table-responsive">
                                <table class="table table-hover" id="budget-items-table">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Subcategory</th>
                                            <th>Payoree</th>
                                            <th>Needs Level</th>
                                            <th>Historical</th>
                                            <th>Budget Amount</th>
                                            <th>Variance</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loading spinner -->
        <div id="loading-spinner" style="display: none;">
            <div class="text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Analyzing your spending patterns...</p>
            </div>
        </div>
        
        <!-- Error display -->
        <div id="error-display" style="display: none;">
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="error-message"></span>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize the wizard
let currentStep = 'config';
let budgetDraft = null;

// Set default dates
document.addEventListener('DOMContentLoaded', function() {
    // Ensure config step is visible on page load
    showStep('config');
    
    const now = new Date();
    const currentYear = now.getFullYear();
    const yearSelect = document.getElementById('starting-year');
    
    // Populate years (current + next 2 years)
    for (let year = currentYear; year <= currentYear + 2; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) option.selected = true;
        yearSelect.appendChild(option);
    }
    
    // Set next month as default
    const nextMonth = (now.getMonth() + 1) % 12 + 1;
    document.getElementById('starting-month').value = nextMonth;
});

function showStep(step) {
    console.log('showStep called with:', step);
    
    // Hide all steps
    document.querySelectorAll('.step-section').forEach(el => el.style.display = 'none');
    document.getElementById('loading-spinner').style.display = 'none';
    document.getElementById('error-display').style.display = 'none';
    
    // Show target step
    const targetStep = document.getElementById('step-' + step);
    if (targetStep) {
        targetStep.style.display = 'block';
        currentStep = step;
        console.log('Showing step:', step);
    } else {
        console.error('Step not found:', 'step-' + step);
        // Fallback to config step if target not found
        const configStep = document.getElementById('step-config');
        if (configStep) {
            configStep.style.display = 'block';
            currentStep = 'config';
        }
    }
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-display').style.display = 'block';
    document.getElementById('loading-spinner').style.display = 'none';
}

async function generateDraft() {
    console.log('generateDraft() function called');
    const form = document.getElementById('config-form');
    const formData = new FormData(form);
    
    // Build query string from form data
    const params = new URLSearchParams();
    for (const [key, value] of formData.entries()) {
        if (key !== 'csrfmiddlewaretoken') {  // Skip CSRF token for GET request
            params.append(key, value);
        }
    }
    console.log('Query parameters:', params.toString());
    
    const apiUrl = '{% url "budgets:api_baseline" %}';
    console.log('API URL:', apiUrl);
    
    // Show loading
    showStep('loading');
    document.getElementById('loading-spinner').style.display = 'block';
    
    try {
        const fullUrl = apiUrl + '?' + params.toString();
        console.log('Full URL:', fullUrl);
        
        const response = await fetch(fullUrl, {
            method: 'GET'
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const responseData = await response.json();
        console.log('Response data:', responseData);
        
        budgetDraft = responseData;
        
        // The response includes a 'draft' property
        if (budgetDraft.success && budgetDraft.draft) {
            budgetDraft = budgetDraft.draft;  // Extract the actual draft data
            console.log('Extracted draft data:', budgetDraft);
        }
        
        populateReview();
        showStep('review');
        
    } catch (error) {
        console.error('Error generating draft:', error);
        showError('Failed to generate budget draft. Please try again.');
    }
}

function populateReview() {
    if (!budgetDraft) return;
    
    console.log('Populating review with budget data:', budgetDraft);
    
    // Populate summary
    const summary = budgetDraft.summary;
    
    // Convert string values to numbers
    const totalSuggested = parseFloat(summary.total_suggested) || 0;
    const totalBaseline = parseFloat(summary.total_baseline) || 0;
    const totalVariance = parseFloat(summary.total_variance) || 0;
    const itemCount = parseInt(summary.item_count) || 0;
    
    document.getElementById('budget-summary').innerHTML = `
        <div class="col-md-3">
            <div class="text-center">
                <h4 class="text-primary">$${totalSuggested.toFixed(2)}</h4>
                <small class="text-muted">Total Budget</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <h4 class="text-info">$${totalBaseline.toFixed(2)}</h4>
                <small class="text-muted">Historical Average</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <h4 class="${totalVariance >= 0 ? 'text-success' : 'text-danger'}">
                    ${totalVariance >= 0 ? '+' : ''}$${totalVariance.toFixed(2)}
                </h4>
                <small class="text-muted">Variance</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <h4 class="text-secondary">${itemCount}</h4>
                <small class="text-muted">Budget Items</small>
            </div>
        </div>
    `;
    
    // Populate table
    const tbody = document.querySelector('#budget-items-table tbody');
    if (tbody && budgetDraft.budget_items) {
        tbody.innerHTML = budgetDraft.budget_items.map((item, index) => `
            <tr>
                <td>${item.category_name || '-'}</td>
                <td>${item.subcategory_name || '-'}</td>
                <td>${item.payoree_name || '-'}</td>
                <td>
                    <span class="badge bg-${getNeedsLevelColor(item.needs_level)}">
                        ${item.needs_level || '-'}
                    </span>
                </td>
                <td>$${parseFloat(item.baseline_amount || 0).toFixed(2)}</td>
                <td>
                    <input type="number" class="form-control form-control-sm" 
                           value="${parseFloat(item.suggested_amount || 0)}" step="0.01" min="0"
                           onchange="updateItemAmount(${index}, this.value)">
                </td>
                <td class="${(parseFloat(item.suggested_amount || 0) - parseFloat(item.baseline_amount || 0)) >= 0 ? 'text-success' : 'text-danger'}">
                    ${(parseFloat(item.suggested_amount || 0) - parseFloat(item.baseline_amount || 0)) >= 0 ? '+' : ''}$${(parseFloat(item.suggested_amount || 0) - parseFloat(item.baseline_amount || 0)).toFixed(2)}
                </td>
                <td>
                    <button class="btn btn-outline-danger btn-sm" onclick="removeItem(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
}

function getNeedsLevelColor(needsLevel) {
    const colors = {
        'Need': 'danger',
        'Want': 'warning', 
        'Wish': 'success'
    };
    return colors[needsLevel] || 'secondary';
}

function updateItemAmount(itemId, newAmount) {
    if (!budgetDraft) return;
    
    const item = budgetDraft.budget_items.find(i => i.id === itemId);
    if (item) {
        item.suggested_amount = parseFloat(newAmount) || 0;
        recalculateSummary();
        populateReview();
    }
}

function removeItem(itemId) {
    if (!budgetDraft) return;
    
    budgetDraft.budget_items = budgetDraft.budget_items.filter(i => i.id !== itemId);
    recalculateSummary();
    populateReview();
}

function recalculateSummary() {
    if (!budgetDraft) return;
    
    const summary = budgetDraft.summary;
    summary.total_baseline = budgetDraft.budget_items.reduce((sum, item) => sum + item.baseline_amount, 0);
    summary.total_suggested = budgetDraft.budget_items.reduce((sum, item) => sum + item.suggested_amount, 0);
    summary.total_variance = summary.total_suggested - summary.total_baseline;
    summary.variance_percentage = summary.total_baseline ? (summary.total_variance / summary.total_baseline * 100) : 0;
    summary.item_count = budgetDraft.budget_items.length;
}

async function commitBudget() {
    if (!budgetDraft) return;
    
    console.log('Committing budget with data:', budgetDraft);
    
    // Show loading
    document.getElementById('loading-spinner').style.display = 'block';
    
    try {
        // Transform budgetDraft into the format expected by the API
        const commitData = {
            budget_items: budgetDraft.budget_items || [],
            target_periods: budgetDraft.periods || [],
            overwrite_existing: true
        };
        
        console.log('Sending commit data:', commitData);
        
        const response = await fetch('{% url "budgets:api_commit" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(commitData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Commit result:', result);
        
        // Redirect to budget list
        window.location.href = '{% url "budgets:list" %}';
        
    } catch (error) {
        console.error('Error committing budget:', error);
        showError('Failed to create budget. Please try again.');
    }
}
</script>
{% endblock %}